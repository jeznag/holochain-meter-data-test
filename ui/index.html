<html>
  <head>
    <script type="text/javascript" src="/meterData.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.22/c3.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.22/c3.js"></script>
  </head>
  <body>
    <h1>Top Buildings</h1>
    <table id="buildingRankTable">
      <thead>
        <tr>
          <th>Building</th>
          <th>Average electricity cost per sq. meter per day</th>
          <th>Average Occupant Comfort Rating</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>

    <div id="chart"></div>

    <script type="text/javascript">
      const BUILDING_NAMES = {
        '1': '44 Blackburn St',
        '2': '52 Harrington Rd',
        '3': '27 Northborne St',
        '4': '13 Waterbird Avenue',
        '5': '8 George Street',
        '6': '15 Collingwood Avenue'
      }
      meterDataRead((rawData) => {
        const processedData = processData(rawData);
        const xValues = Object.entries(processedData).map(([buildingID, data]) => {
          return ['x'].concat(data.data.map((datum) => new Date(datum.timestamp)));
        });
        const dataForChart = Object.entries(processedData).map(([buildingID, data]) => {
          const dataForC3 = [BUILDING_NAMES[buildingID]];
          return dataForC3.concat(data.data.map((datum) => datum.power_consumed_kwh));
        });
        debugger;
        const chart = c3.generate({
          bindto: '#chart',
          data: {
            x: 'x',
            columns: xValues.concat(dataForChart)
          },
          axis: {
            x: {
              type: 'timeseries',
              tick: {
                format: '%Y-%m-%d'
              }
            }
          }
        });
        const buildingsRankedByElectricityUsage = Object.keys(processedData).slice().sort((a, b) => {
          return b.averageUsagePerDay - a.averageUsagePerDay;
        });
        const tableBodyEl = document.querySelector('#buildingRankTable tbody');
        buildingsRankedByElectricityUsage.forEach((buildingID) => {
          const buildingData = processedData[buildingID];
          tableBodyEl.innerHTML += `<tr>
            <td>${BUILDING_NAMES[buildingID]}</td>
            <td>${buildingData.averageSpendPerDay}</td>
            <td>TODO</td>
          </tr>`;
        });
      });
    </script>
  </body>
</html>
